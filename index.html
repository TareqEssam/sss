<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ù…ØµØ±ÙŠØ©</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1>ğŸ¯ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ</h1>
                <p>Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ Ù…ØªØ·ÙˆØ± - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</p>
            </div>
            <div class="status">
                <span id="status-indicator" class="status-loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                <span id="db-size" class="db-info"></span>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">
                <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ± Ø§Ù„Ø°ÙƒÙŠ ğŸ“</h2>
                <p>Ù†Ø¸Ø§Ù… Ø°ÙƒØ§Ø¡ Ù…ØªÙ‚Ø¯Ù… Ù„ÙÙ‡Ù… Ø¹Ù…ÙŠÙ‚ ÙˆØ¯Ù‚ÙŠÙ‚ Ù„Ø§Ø³ØªÙØ³Ø§Ø±Ø§ØªÙƒ</p>
                
                <div style="margin: 20px 0; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                    <span class="intelligence-badge">
                        <span>ğŸ§ </span>
                        <span>ÙÙ‡Ù… Ø³ÙŠØ§Ù‚ÙŠ Ø°ÙƒÙŠ</span>
                    </span>
                    <span class="intelligence-badge">
                        <span>ğŸ¯</span>
                        <span>ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ÙˆØ§ÙŠØ§</span>
                    </span>
                    <span class="intelligence-badge">
                        <span>âœ¨</span>
                        <span>Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ø­ØªØ±Ø§ÙÙŠØ©</span>
                    </span>
                </div>
                
                <ul>
                    <li>âœ… Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ ÙˆØ§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ© Ù„ÙƒÙ„ Ù†Ø´Ø§Ø·</li>
                    <li>ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</li>
                    <li>ğŸ­ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© ÙˆÙ‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</li>
                    <li>ğŸ’° Ø­ÙˆØ§ÙØ² Ø§Ù„Ù‚Ø±Ø§Ø± 104 ÙˆØªØµÙ†ÙŠÙ Ø§Ù„Ù‚Ø·Ø§Ø¹Ø§Øª</li>
                </ul>
                
                <p style="margin-top: 20px; color: #666;">Ø¬Ø±Ù‘Ø¨ Ø£Ù† ØªØ³Ø£Ù„ Ø£ÙŠ Ø³Ø¤Ø§Ù„ ğŸ‘‡</p>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="quick-questions">
                <button class="quick-btn" onclick="askQuestion('Ù…Ø§ Ù‡ÙŠ Ø´Ø±ÙˆØ· ØªØ±Ø®ÙŠØµ Ù…ØµÙ†Ø¹ Ù…Ù„Ø§Ø¨Ø³ØŸ')">
                    Ø´Ø±ÙˆØ· ØªØ±Ø®ÙŠØµ Ù…ØµÙ†Ø¹ Ù…Ù„Ø§Ø¨Ø³
                </button>
                <button class="quick-btn" onclick="askQuestion('Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©')">
                    Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©
                </button>
                <button class="quick-btn" onclick="askQuestion('Ù‡Ù„ ØµÙ†Ø§Ø¹Ø© Ø§Ù„Ø£Ø¯ÙˆÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø± 104ØŸ')">
                    Ø§Ù„Ù‚Ø±Ø§Ø± 104
                </button>
            </div>
            
            <div class="input-wrapper">
                <textarea 
                    id="query-input" 
                    placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§..."
                    rows="1"
                ></textarea>
                <button id="send-btn" onclick="sendQuery()">
                    <span>Ø¥Ø±Ø³Ø§Ù„</span>
                    <span>ğŸ“¤</span>
                </button>
            </div>
            
            <div id="memory-indicator" class="memory-indicator"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="loader.js"></script>
    <script src="intent-engine-v2.js"></script>
    <script src="core-v5-expert.js"></script>
    
    <script>
        let conversationHistory = [];
        let isProcessing = false;

        // Initialize on load
        window.addEventListener('load', async () => {
            try {
                const statusIndicator = document.getElementById('status-indicator');
                const dbSize = document.getElementById('db-size');
                
                statusIndicator.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                
                // Initialize data loader
                await DataLoader.initialize();
                
                const totalVectors = DataLoader.getTotalVectors();
                
                statusIndicator.textContent = 'âœ… Ø¬Ø§Ù‡Ø²';
                statusIndicator.className = 'status-ready';
                dbSize.textContent = `ğŸ“Š ${totalVectors.toLocaleString('ar-EG')} Ø¹Ù†ØµØ±`;
                
                console.log('âœ… Ø§Ù„Ù†Ø¸Ø§Ù… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø¹Ù…Ù„');
                
                // Focus on input
                document.getElementById('query-input')?.focus();
                
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªÙ‡ÙŠØ¦Ø©:', error);
                const statusIndicator = document.getElementById('status-indicator');
                statusIndicator.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                statusIndicator.className = 'status-error';
                
                addMessage('system', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©.');
            }
        });

        async function sendQuery() {
            const input = document.getElementById('query-input');
            const sendBtn = document.getElementById('send-btn');
            const query = input.value.trim();

            if (!query || isProcessing) return;

            isProcessing = true;
            input.disabled = true;
            sendBtn.disabled = true;

            try {
                // Add user message
                addMessage('user', query);
                input.value = '';
                input.style.height = 'auto';

                // Show thinking message
                const thinkingId = addMessage('assistant', 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...', true);

                // Process query
                const result = await ExpertAssistant.processQuery(query);

                // Remove thinking message
                document.getElementById(thinkingId)?.remove();

                // Add assistant response
                addMessage('assistant', result.answer, false, result, result.processingTime);

                // Update conversation history
                conversationHistory.push({
                    query: query,
                    intent: result.intent,
                    entities: result.entities,
                    sources: result.results
                });

                // Keep only last 5
                if (conversationHistory.length > 5) {
                    conversationHistory.shift();
                }

                updateMemoryIndicator();

            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£:', error);
                addMessage('system', 'Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
            } finally {
                isProcessing = false;
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        function addMessage(type, content, isTemp = false, data = null, processingTime = null) {
            const chatContainer = document.getElementById('chat-container');
            
            // Remove welcome message on first interaction
            const welcome = chatContainer.querySelector('.welcome-message');
            if (welcome && type === 'user') {
                welcome.remove();
            }
            
            const messageId = `msg-${Date.now()}-${Math.random()}`;
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message${isTemp ? ' thinking' : ''}`;
            messageDiv.id = messageId;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            } else if (type === 'assistant') {
                let intelligenceHtml = '';
                if (data && !isTemp) {
                    intelligenceHtml = '<div class="analysis-panel">';
                    
                    if (data.intent && data.intent.primary) {
                        const intentAr = getIntentNameArabic(data.intent.primary.name);
                        const confidence = (data.intent.primary.confidence * 100).toFixed(0);
                        intelligenceHtml += `
                            <div class="analysis-item">
                                <span>ğŸ¯</span>
                                <span><strong>Ø§Ù„Ù†ÙŠØ©:</strong> ${intentAr} (${confidence}%)</span>
                            </div>
                        `;
                    }
                    
                    if (data.confidence) {
                        const confPercent = (data.confidence * 100).toFixed(1);
                        intelligenceHtml += `
                            <div class="analysis-item">
                                <span>ğŸ“Š</span>
                                <span><strong>Ø¯Ù‚Ø© Ø§Ù„Ù†ØªÙŠØ¬Ø©:</strong> ${confPercent}%</span>
                            </div>
                        `;
                    }
                    
                    if (processingTime) {
                        intelligenceHtml += `
                            <div class="analysis-item">
                                <span>âš¡</span>
                                <span><strong>Ø²Ù…Ù† Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©:</strong> ${processingTime}Ø«</span>
                            </div>
                        `;
                    }
                    
                    if (data.entities && Object.keys(data.entities).length > 0) {
                        const entitiesStr = Object.values(data.entities).flat().slice(0, 3).join('ØŒ ');
                        intelligenceHtml += `
                            <div class="analysis-item">
                                <span>ğŸ·ï¸</span>
                                <span><strong>Ø§Ù„ÙƒÙŠØ§Ù†Ø§Øª:</strong> ${escapeHtml(entitiesStr)}</span>
                            </div>
                        `;
                    }
                    
                    intelligenceHtml += '</div>';
                }

                let sourcesHtml = '';
                if (data && data.sources && data.sources.length > 0 && !isTemp) {
                    sourcesHtml = '<div class="sources">';
                    sourcesHtml += '<div class="sources-header">ğŸ“š Ø§Ù„Ù…ØµØ§Ø¯Ø± Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø©:</div>';
                    data.sources.slice(0, 3).forEach((src, idx) => {
                        const confidence = (src.score * 100).toFixed(1);
                        const confidenceClass = confidence > 75 ? 'high' : confidence > 60 ? 'medium' : 'low';
                        sourcesHtml += `
                            <div class="source-item">
                                <span class="source-label">${idx + 1}.</span>
                                <span class="source-text">${escapeHtml(src.text)}</span>
                                <span class="confidence ${confidenceClass}">${confidence}%</span>
                            </div>
                        `;
                    });
                    sourcesHtml += '</div>';
                }

                messageDiv.innerHTML = `
                    <div class="message-content">${formatAnswer(content)}</div>
                    ${intelligenceHtml}
                    ${sourcesHtml}
                `;
            } else {
                messageDiv.className = 'message system-message';
                messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageId;
        }

        function getIntentNameArabic(intentName) {
            const mapping = {
                'ACTIVITY_LICENSE': 'Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ',
                'ACTIVITY_AUTHORITY': 'Ø§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ©',
                'ACTIVITY_LAW': 'Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ†',
                'ACTIVITY_GUIDE': 'Ø§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©',
                'ACTIVITY_LOCATION': 'Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨Ø©',
                'ACTIVITY_TECHNICAL': 'Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙ†ÙŠØ©',
                'ACTIVITY_DESCRIPTION': 'ØªÙˆØµÙŠÙ Ø§Ù„Ù†Ø´Ø§Ø·',
                'INDUSTRIAL_ZONE': 'Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ©',
                'INDUSTRIAL_ZONE_AUTHORITY': 'Ø¬Ù‡Ø© Ø§Ù„ÙˆÙ„Ø§ÙŠØ©',
                'INDUSTRIAL_ZONE_DECISION': 'Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡',
                'INDUSTRIAL_ZONE_AREA': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
                'INDUSTRIAL_ZONE_CHECK': 'Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                'DECISION104': 'Ø§Ù„Ù‚Ø±Ø§Ø± 104',
                'DECISION104_SECTOR': 'Ù‚Ø·Ø§Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø± 104',
                'GENERAL': 'Ø¹Ø§Ù…'
            };
            return mapping[intentName] || intentName;
        }

        function formatAnswer(text) {
            text = escapeHtml(text);
            
            // Headers
            text = text.replace(/###\s+(.+)/g, '<h3 style="margin: 15px 0 10px 0; color: var(--primary-color);">$1</h3>');
            text = text.replace(/####\s+(.+)/g, '<h4 style="margin: 10px 0 8px 0; color: var(--text-primary);">$1</h4>');
            
            // Bold
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            
            // Italic
            text = text.replace(/\*(.+?)\*/g, '<em style="color: var(--text-secondary);">$1</em>');
            
            // Line breaks
            text = text.replace(/\n/g, '<br>');
            
            // Bullet points
            text = text.replace(/^â€¢\s+(.+)$/gm, '&nbsp;&nbsp;&nbsp;â€¢ $1');
            
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function askQuestion(question) {
            document.getElementById('query-input').value = question;
            sendQuery();
        }

        function updateMemoryIndicator() {
            const indicator = document.getElementById('memory-indicator');
            const count = conversationHistory.length;
            
            if (count > 0) {
                const lastIntent = conversationHistory[conversationHistory.length - 1].intent;
                const intentAr = lastIntent?.primary ? getIntentNameArabic(lastIntent.primary.name) : 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯';
                indicator.innerHTML = `ğŸ’­ Ø§Ù„Ø³ÙŠØ§Ù‚: ${count}/5 Ù…Ø­Ø§Ø¯Ø«Ø§Øª | Ø¢Ø®Ø± Ù…ÙˆØ¶ÙˆØ¹: ${intentAr}`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Auto-resize textarea
        document.getElementById('query-input')?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Enter to send, Shift+Enter for new line
        document.getElementById('query-input')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuery();
            }
        });
    </script>
    
    <style>
        .intelligence-badge {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .analysis-panel {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-top: 12px;
            font-size: 0.9rem;
            border-right: 3px solid #667eea;
        }

        .analysis-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 5px 0;
            color: var(--text-secondary);
        }

        .message.thinking .message-content {
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</body>
</html>
