<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ± - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„Ù…ØµØ±ÙŠØ©</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1>ğŸ¯ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ±</h1>
                <p>Ù…Ø³Ø§Ø¹Ø¯ Ù„Ø¬Ø§Ù† Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© - Ø§Ù„Ù‡ÙŠØ¦Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ø§Ø³ØªØ«Ù…Ø§Ø±</p>
            </div>
            <div class="status">
                <span id="status-indicator" class="status-loading">â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</span>
                <span id="db-size" class="db-info"></span>
            </div>
        </header>

        <!-- Chat Area -->
        <div class="chat-container" id="chat-container">
            <div class="welcome-message">
                <h2>Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø³ØªØ´Ø§Ø± Ø§Ù„Ø®Ø¨ÙŠØ±</h2>
                <p>ÙŠÙ…ÙƒÙ†Ù†ÙŠ Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ ÙÙŠ:</p>
                <ul>
                    <li>âœ… Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ ÙˆØ§Ù„Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø®ØªØµØ© Ù„ÙƒÙ„ Ù†Ø´Ø§Ø·</li>
                    <li>ğŸ“‹ Ø§Ù„Ù‚ÙˆØ§Ù†ÙŠÙ† ÙˆØ§Ù„Ø£Ø¯Ù„Ø© Ø§Ù„Ø¥Ø±Ø´Ø§Ø¯ÙŠØ©</li>
                    <li>ğŸ­ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© ÙˆÙ‚Ø±Ø§Ø±Ø§Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</li>
                    <li>ğŸ’° Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù‚Ø±Ø§Ø± 104 ÙˆØ§Ù„Ø­ÙˆØ§ÙØ²</li>
                    <li>ğŸ” Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„ÙÙ†ÙŠØ© Ù„Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©</li>
                </ul>
            </div>
        </div>

        <!-- Input Area -->
        <div class="input-container">
            <div class="quick-questions" id="quick-questions">
                <button class="quick-btn" onclick="askQuestion('Ù…Ø§ Ù‡ÙŠ Ø§Ù„ØªØ±Ø§Ø®ÙŠØµ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØŸ')">
                    ğŸ­ Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„ØµÙ†Ø§Ø¹ÙŠ
                </button>
                <button class="quick-btn" onclick="askQuestion('Ù…Ø§ Ù‡ÙŠ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„ØµÙ†Ø§Ø¹ÙŠØ© Ø¨Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©ØŸ')">
                    ğŸ“ Ù…Ù†Ø§Ø·Ù‚ Ø§Ù„Ù‚Ø§Ù‡Ø±Ø©
                </button>
                <button class="quick-btn" onclick="askQuestion('Ù‡Ù„ Ø®Ù„Ø§ÙŠØ§ Ø§Ù„Ø·Ø§Ù‚Ø© Ø§Ù„Ø´Ù…Ø³ÙŠØ© ÙÙŠ Ø§Ù„Ù‚Ø±Ø§Ø± 104ØŸ')">
                    ğŸ’° Ø§Ù„Ù‚Ø±Ø§Ø± 104
                </button>
            </div>
            <div class="input-wrapper">
                <textarea 
                    id="query-input" 
                    placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... (Ø§Ø¶ØºØ· Enter Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ Shift+Enter Ù„Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯)"
                    rows="1"
                    disabled
                ></textarea>
                <button id="send-btn" onclick="sendQuery()" disabled>
                    <span>Ø¥Ø±Ø³Ø§Ù„</span>
                    <span class="icon">ğŸ“¤</span>
                </button>
            </div>
            <div class="memory-indicator" id="memory-indicator"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="loader.js"></script>
    <script src="intent-engine.js"></script>
    <script src="core.js"></script>
    <script>
        let conversationHistory = [];

        // Initialize on load
        window.addEventListener('load', async () => {
            await initializeSystem();
        });

        async function initializeSystem() {
            const statusEl = document.getElementById('status-indicator');
            const inputEl = document.getElementById('query-input');
            const sendBtn = document.getElementById('send-btn');

            try {
                statusEl.textContent = 'â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
                statusEl.className = 'status-loading';

                // Load data
                const startTime = Date.now();
                await DataLoader.initialize();
                const loadTime = ((Date.now() - startTime) / 1000).toFixed(2);

                // Update UI
                statusEl.textContent = 'âœ… Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…';
                statusEl.className = 'status-ready';
                
                const dbSize = document.getElementById('db-size');
                dbSize.textContent = `ğŸ“Š ${DataLoader.getTotalVectors()} Ù…ØªØ¬Ù‡ | âš¡ ${loadTime}Ø«`;

                inputEl.disabled = false;
                sendBtn.disabled = false;
                inputEl.focus();

            } catch (error) {
                statusEl.textContent = 'âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„';
                statusEl.className = 'status-error';
                console.error('Initialization error:', error);
                addMessage('system', `Ø­Ø¯Ø« Ø®Ø·Ø£: ${error.message}`);
            }
        }

        async function sendQuery() {
            const input = document.getElementById('query-input');
            const query = input.value.trim();
            
            if (!query) return;

            // Add user message
            addMessage('user', query);
            input.value = '';
            input.style.height = 'auto';

            // Show thinking indicator
            const thinkingId = addMessage('assistant', 'ğŸ¤” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªÙÙƒÙŠØ±...', true);

            try {
                // Process query
                const result = await ExpertAssistant.answer(query, conversationHistory);
                
                // Remove thinking indicator
                document.getElementById(thinkingId)?.remove();

                // Add assistant response
                addMessage('assistant', result.answer, false, result);

                // Update conversation history
                conversationHistory.push({
                    question: query,
                    answer: result.answer,
                    intent: result.intent,
                    entities: result.entities,
                    timestamp: Date.now()
                });

                // Keep only last 5 exchanges
                if (conversationHistory.length > 5) {
                    conversationHistory = conversationHistory.slice(-5);
                }

                updateMemoryIndicator();

            } catch (error) {
                document.getElementById(thinkingId)?.remove();
                addMessage('system', `Ø®Ø·Ø£: ${error.message}`);
            }
        }

        function addMessage(type, content, isTemp = false, data = null) {
            const chatContainer = document.getElementById('chat-container');
            const messageId = `msg-${Date.now()}-${Math.random()}`;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            messageDiv.id = messageId;

            if (type === 'user') {
                messageDiv.innerHTML = `
                    <div class="message-content">${escapeHtml(content)}</div>
                `;
            } else if (type === 'assistant') {
                let sourcesHtml = '';
                if (data && data.sources && data.sources.length > 0) {
                    sourcesHtml = '<div class="sources">';
                    sourcesHtml += '<div class="sources-header">ğŸ“š Ø§Ù„Ù…ØµØ§Ø¯Ø±:</div>';
                    data.sources.forEach((src, idx) => {
                        const confidence = (src.score * 100).toFixed(0);
                        const confidenceClass = confidence > 80 ? 'high' : confidence > 60 ? 'medium' : 'low';
                        sourcesHtml += `
                            <div class="source-item">
                                <span class="source-label">${idx + 1}.</span>
                                <span class="source-text">${escapeHtml(src.text)}</span>
                                <span class="confidence ${confidenceClass}">${confidence}%</span>
                            </div>
                        `;
                    });
                    sourcesHtml += '</div>';
                }

                messageDiv.innerHTML = `
                    <div class="message-content">${formatAnswer(content)}</div>
                    ${sourcesHtml}
                `;
            } else {
                messageDiv.className = 'message system-message';
                messageDiv.innerHTML = `<div class="message-content">${escapeHtml(content)}</div>`;
            }

            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageId;
        }

        function formatAnswer(text) {
            // Format the answer with better readability
            text = escapeHtml(text);
            
            // Bold headers
            text = text.replace(/^(#+)\s*(.+)$/gm, '<strong>$2</strong>');
            
            // Line breaks
            text = text.replace(/\n/g, '<br>');
            
            // Bullet points
            text = text.replace(/^-\s+(.+)$/gm, 'â€¢ $1');
            
            return text;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function askQuestion(question) {
            document.getElementById('query-input').value = question;
            sendQuery();
        }

        function updateMemoryIndicator() {
            const indicator = document.getElementById('memory-indicator');
            const count = conversationHistory.length;
            
            if (count > 0) {
                indicator.innerHTML = `ğŸ’­ Ø§Ù„Ø°Ø§ÙƒØ±Ø©: ${count}/5 Ù…Ø­Ø§Ø¯Ø«Ø§Øª Ø³Ø§Ø¨Ù‚Ø©`;
                indicator.style.display = 'block';
            } else {
                indicator.style.display = 'none';
            }
        }

        // Auto-resize textarea
        document.getElementById('query-input')?.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 150) + 'px';
        });

        // Enter to send, Shift+Enter for new line
        document.getElementById('query-input')?.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuery();
            }
        });
    </script>
</body>
</html>